<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.heroland.competition.dal.mapper.HeroLandCompetitionRecordExtMapper">

    <resultMap id="CompetitionQuestionsMap" type="com.heroland.competition.dal.pojo.HeroLandCompetitionRecordQuestions">
        <collection property="details"
                    resultMap="com.heroland.competition.dal.mapper.HeroLandQuestionRecordDetailMapper.BaseResultMap"
                    ofType="com.heroland.competition.dal.pojo.HeroLandQuestionRecordDetail"/>
    </resultMap>

    <select id="selectCompetitionRecordsAndQuestions"
            resultMap="com.heroland.competition.dal.mapper.HeroLandCompetitionRecordMapper.BaseResultMap">

        select a.* ,b.* from heroland_competition_record a left join heroland_question_record_detail b
        on a.record_id = b.record_id
        where a.is_deleted = 0 and b.is_deleted = 0

        <if test="topic != null and topic != ''">
            and a.topic = #{topic,jdbcType=VARCHAR}
        </if>

        <if test="recordId != null and recordId != ''">
            and a.record_id = #{recordId,jdbcType=VARCHAR}
        </if>

        <if test="startRow != null and startRow != -1 and pageSize != null">
            limit #{startRow,jdbcType=INTEGER},#{pageSize,jdbcType=INTEGER}
        </if>

    </select>

    <select id="countCompetitionRecordsAndQuestions"
            resultType="Long">

        select count(a.*) from heroland_competition_record a left join heroland_question_record_detail b
        on a.record_id = b.record_id
        where a.is_deleted = 0 and b.is_deleted = 0

        <if test="topic != null and topic != ''">
            and a.topic = #{topic,jdbcType=VARCHAR}
        </if>

        <if test="recordId != null and recordId != ''">
            and a.record_id = #{recordId,jdbcType=VARCHAR}
        </if>

    </select>

    <select id="getTotalScore"
            resultMap="com.heroland.competition.dal.mapper.HeroLandStatisticsTotalMapper.BaseResultMap">


        select
        sum(total_score) total_score,user_id ,topic_type,grade_code,class_code ,org_code,
        sum(total_score)/sum(competitionCount) avgScore,sum(competitionCount) total_games from (
        select sum(invite_score) total_score,invite_id user_id ,topic_type topic_type
        ,class_code class_code,grade_code grade_code,org_code org_code
        ,count(invite_score) competitionCount
        from heroland_competition_record
        where is_deleted = 0
        <if test="topicType != null">
            and topic_type = #{topicType}
        </if>

        GROUP BY org_code,topic_type,grade_code
        ,invite_id

        union all

        select sum(opponent_score) total_score , opponent_id user_id ,topic_type topic_type
        ,class_code class_code,grade_code grade_code,org_code org_code,
        count(opponent_score) competitionCount
        from heroland_competition_record
        where is_deleted = 0
        <if test="topicType != null">
            and topic_type = #{topicType}
        </if>


        GROUP BY org_code,topic_type,grade_code
        ,opponent_id

        ) a
        GROUP BY user_id

    </select>


    <select id="getTotalScoreDetail"
            resultMap="com.heroland.competition.dal.mapper.HeroLandStatisticsTotalMapper.BaseResultMap">


        select
        sum(total_score) total_score,user_id ,topic_type,grade_code,class_code ,org_code,subject_code
        sum(total_score)/sum(competitionCount) avgScore,sum(competitionCount) total_games from (
        select sum(invite_score) total_score,invite_id user_id ,topic_type topic_type
        ,class_code class_code,grade_code grade_code,org_code org_code,subject_code
        ,count(invite_score) competitionCount
        from heroland_competition_record
        where is_deleted = 0
        <if test="topicType != null">
            and topic_type = #{topicType}
        </if>
        GROUP BY org_code,topic_type,grade_code,class_code,subject_code
        ,invite_id
        union all

        select sum(opponent_score) total_score , opponent_id user_id ,topic_type topic_type
        ,class_code class_code,grade_code grade_code,org_code org_code,subject_code
        count(opponent_score) competitionCount
        from heroland_competition_record
        where is_deleted = 0
        <if test="topicType != null">
            and topic_type = #{topicType}
        </if>

        GROUP BY org_code,topic_type,grade_code,class_code,subject_code
        ,opponent_id

        ) a
        GROUP BY user_id

    </select>
    <select id="selectByTopicIdsAndInviterId" resultType="com.heroland.competition.dal.pojo.HeroLandCompetitionRecord">
        select *
        from heroland_competition_record
        where is_deleted = 0
        and topic_id in
        <foreach collection="topicIds" open="(" separator="," close=")" index="i" item="topicId">
            #{topicId}
        </foreach>
        and invite_id = #{userId}
    </select>
</mapper>